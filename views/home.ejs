<!-- views/home.ejs -->

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/styles/user.css">
  <title>홈</title>
</head>
<body>
    <div class="user">
        <% if (user) { %>
          <h2 id="user-info">
            <span id="user-name"><%= user.username %></span>
            <br>
            <span id="user-point"><%= user.point %>P</span>
          </h2>
          <span id="tools">
            <a href="/edit-profile" class="buttons">정보 수정</a>
            <a href="/send-points" class="buttons">포인트<br>보내기</a>
            <a href="/logout" class="buttons">로그아웃</a>
          </span>
        <% } else { %>
          <span id="tools">
          <a href="/login" class="buttons">로그인</a> <a href="/register" class="buttons">회원가입</a>
          </span>
        <% } %>
        <div id="rank-table"></div>
        <a href="/rank-list" class="buttons">전체 순위표</a>
    </div>
    <a href="/mine" class="entry">버튼</a>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      $(document).ready(function () {
        const socket = io();

        function updateRank() {
          $.get('/rank', function (data) {
            const rankTable = $('#rank-table');
            rankTable.empty();

            rankTable.append('<h3>순위표</h3>');
            rankTable.append('<table><tbody></tbody></table>');

            const topUsers = data.users.slice(0, 5);

            const tbody = rankTable.find('tbody');
            topUsers.forEach(function (user, index) {
              const rank = index + 1;
              tbody.append(`<tr><td>${rank}</td><td>${user.username}</td><td>${user.point}</td></tr>`);
            });
            $.get('/user-point', function(data) {
                $('#user-point').text(data.point + 'P');
            });
          });
        }

        // 페이지 로드 시 초기 업데이트
        updateRank();

        // 서버에서 'update-rank' 이벤트를 받을 때마다 업데이트
        socket.on('update-rank', updateRank);
      });
    </script>
</body>
</html>
